version: '3.0'
services:
  web:
    image: eu.gcr.io/ems-plugins/magento:2.2.3
    ports:
      - "8888:80"
    links:
      - db
    env_file:
      - .env
    volumes:
      - ./Magento/composer.json:/var/www/html/composer.json
      - ./..:/var/www/html/vendor/emartech/emarsys-magento2-extension
      - ./setup:/etc/my_init.d/setup
      - ./php.ini:/usr/local/etc/php/php.ini
    command: ["/opt/wait-for-it.sh", "db:3306", "--timeout=30", "--strict", "--", "/sbin/my_init"]
  db:
    image: healthcheck/percona
    restart: always
    volumes:
      - ./fresh-magento-sampledata.sql:/docker-entrypoint-initdb.d/magento.sql
      - magento-db:/var/lib/mysql
      - ./uninstall-extension.sql:/opt/uninstall-extension.sql
      - ./magento.sql:/opt/magento.sql
    ports:
      - "13306:3306"
    env_file:
      - .env
  node:
    image: "node:9.11.1-alpine"
    links:
      - db
    user: "node"
    working_dir: /test
    env_file:
      - .env
    volumes:
      - ./test:/test
    expose:
      - "8081"
    command: "npm i"
volumes:
  magento-db: